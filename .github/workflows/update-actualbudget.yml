name: Trigger rebuild from external branch
on:
  schedule:
    # Once a day.
    - cron: '0 0 * * *'
  # allow manual trigger
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  check-actualbudget-version:
    name: Check Actual Budget version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        
      - name: Get latest release tag
        run: |
          release_tag=$(curl -s https://api.github.com/repos/actualbudget/actual-server/releases/latest | jq -r '.tag_name' | cut -d 'v' -f 2)
      
      - name: Update version in YAML file
        run: |
          current_version=$(grep -Po '(?<=version: ")[0-9]+\.[0-9]+\.[0-9]+' actualbudget/config.yaml)
          if [[ "$release_tag" != "$current_version" ]]; then
            sed -i "s/$current_version/$release_tag/g" actualbudget/config.yaml
            git config --global user.email "github-actions@github.com"
            git config --global user.name "Github Actions"
            git commit -am "Update version to $release_tag"
            git push
          fi
